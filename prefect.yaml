name: budget_flows
prefect-version: 3.0.0

build: null

# runs inside the container every time a job starts
pull:
  - prefect.deployments.steps.git_clone:
      id: clone_step
      repository: https://github.com/Selovert/simplefin-archiver.git
      branch: main
      # access_token: "{{ prefect.blocks.secret.github-token }}"

  - prefect.deployments.steps.run_shell_script:
      id: install-deps
      script: >-
        /bin/sh -c "pip install uv &&
        uv pip install --system ."
      directory: "{{ clone_step.directory }}"
      stream_output: true

# reusable configs
definitions:
  work_pools:
    ab_docker_config: &docker_common
      name: docker-pool
      job_variables:
        image: prefecthq/prefect:3-latest
        networks:
          - prefect
          - actual_budget
        # mount host cache to the container cache
        volumes:
          - "/opt/prefect/uv-cache:/root/.cache/uv"
        env:
          UV_CACHE_DIR: "/root/.cache/uv"
          PREFECT_LOGGING_LEVEL: INFO

deployments:
  - name: hello-world
    entrypoint: flows/hello_world.py:hello
    # schedule:
    #   cron: "0 6 * * *"
    #   timezone: "America/New_York"
    # Use the anchor above to copy common settings
    work_pool: *docker_common
